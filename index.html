<html>
<head>
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-154852876-1"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'UA-154852876-1');
	</script>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
	<meta charset="utf-8"/>
      <style>
		@media screen and (max-width: 480px){
			body{
			}
		}
	      body {
		      font-family: sans-serif;
	      }
		  strong {
			font-weight: bold;
			color: red;
		  }
		  
		  h1{
			font-size: 120%;
		  }
		  #location, #description{
			font-size: small;
		  }
		  h2 {
			margin: 0px;
		  }
		  ul, ol {
			margin: 0px;
		  }
		  
			
		#maps {
            display: table;
			}
		ul.submaps{
            display: inline-block;
			vertical-align: top;
            white-space: nowrap;
			padding: 0 0 0 20px;

        }
		.title{
			background-color: #eee;
			font-weight: bold;
			font-size: larger;
			text-align: center;
		}
		ul.submaps li{
			list-style: none;
			margin: 5px;
		}
		img {
			padding: 0px 5px;
			vertical-align: middle;
		}
      </style>
</head>
<body>
  <h1>üó∫Ô∏èOpenSwitchMaps Webüó∫Ô∏è</h1>

<div id="description">
<p>OpenSwitchMaps helps you to switch between map services, such as Google maps, OpenStreetMap, Bing map and so on.
You can jump to another map service keeping the location and the zoom level</p>
 
  <h2>How to use</h2>
  <ol>
    <li><strong>First, add a bookmark(bookmarklet) to your browser</strong>: Drag following link to your bookmark bar: <a href="javascript:(function(){ window.location.href='https://tankaru.github.io/OpenSwitchMapsWeb/index.html#'+location.href;})();">OpenSwitchMaps Web</a> OR bookmark following text(bookmarklet)</li>
	
      <code>javascript:(function(){ window.location.href='https://tankaru.github.io/OpenSwitchMapsWeb/index.html#'+location.href;})();</code>
    <li>Open a map service, for example <a href="https://www.openstreetmap.org">OpenStreetMap</a></li>
    <li>Open saved bookmarklet</li>
    <li>You will move to a web page(here). And you will get links to jump to other map service.</li>
  </ol>

</div>
<div id="location">
    <h2>Location info</h2>
  <ul>
    <li>URL: <i><span id="showurl"></span></i></li>
    <li>Lat: <i><span id="lat"><span></i>, Lon: <i><span id="lon"><span></i>, Zoom: <i><span id="zoom"><span></i></li>
    <li>Address: <i><span id="address"></span></i></li>
  </ul>
  </div>

  <span id="sorry"></span>

<div id="results">
  <h2>Switch to ...</h2>
  <div id="maps">

  </div>
</div>  


  <p>Comments and bug reports are welcome at <a href="https://github.com/tankaru/OpenSwitchMapsWeb">Github</a>.</p>
  <p>Address data is obtained from <a href="https://operations.osmfoundation.org/policies/nominatim/">Nominatim</a>.</p>

<script>

const MAIN_CATEGORY = "Main maps";
const UTILITY_CATEGORY = "Utilities";
const OTHER_CATEGORY = "Other maps";
const SPECIAL_CATEGORY = "Specials";
const LOCAL_CATEGORY = "Local maps";
const OSM_LOCAL_CATEGORY = "OSM local chapter";
const APP_CATEGORY = "External App";
const PORTAL_CATEGORY = "Map potal";

function setLocalwikiAddress(lat, lon){
	let request = new XMLHttpRequest();
	request.open('GET', 'https://nominatim.openstreetmap.org/reverse?format=json&lat=' + lat + '&lon=' + lon + '&zoom=10&addressdetails=1', true);
	request.responseType = 'json';
	request.onload = function () {
		let data = this.response;
		document.getElementById('Localwiki').setAttribute('href','https://localwiki.org/_search/?q=' + data.display_name);
	};
	request.send();
}


function bboxToLatLonZoom(minlon, minlat, maxlon, maxlat) {
	const lon = (Number(minlon) + Number(maxlon))/2.0;
	const lat = (Number(minlat) + Number(maxlat))/2.0;
	const part = (Number(maxlat) - Number(minlat))/360.0;
	const zoom = Math.log(part)/Math.log(0.5); //0.5^zoom=part
	return [lat, lon, zoom];

}

function latLonZoomToBbox(lat, lon, zoom) {
	const part = Math.pow(0.5,zoom);
	const minlon = Number(lon) - 360*part/2;
	const maxlon = Number(lon) + 360*part/2;
	const minlat = Number(lat) - 180*part/2;
	const maxlat = Number(lat) + 180*part/2;
	return [minlon, minlat, maxlon, maxlat];

}

const maps = [
  {
    name: "Google Maps",
    category: MAIN_CATEGORY,
    domain: "www.google.com",
    getUrl(lat, lon, zoom) {
      return 'https://www.google.com/maps/@' + lat + ',' + lon + ',' + zoom + 'z';
    },
    getLatLonZoom(url) {
      let match;
      if (match = url.match(/google.*maps.*@(-?\d[0-9.]*),(-?\d[0-9.]*),(\d{1,2})[.z]/)) {
        const [, lat, lon, zoom] = match;
        return [lat, lon, zoom];
      } else if (match = url.match(/google.*maps.*@(-?\d[0-9.]*),(-?\d[0-9.]*),(\d[0-9.]*)[m]/)) {
        let [, lat, lon, zoom] = match;
        zoom = Math.round(-1.4436 * Math.log(zoom) + 26.871);
        return [lat, lon, zoom];
      } else if (match = url.match(/google.*maps.*@(-?\d[0-9.]*),(-?\d[0-9.]*),([0-9]*)[a],[0-9.]*y/)) {
        let [, lat, lon, zoom] = match;
        zoom = Math.round(-1.44 * Math.log(zoom) + 27.5);
        return [lat, lon, zoom];
      }

    },
  },
  

  
  {
    name: "OpenStreetMap",
    category: MAIN_CATEGORY,
    domain: "www.openstreetmap.org",
    getUrl(lat, lon, zoom) {
      return 'https://www.openstreetmap.org/#map=' + zoom + '/' + lat + '/' + lon;
    },
    getLatLonZoom(url) {
      const match = url.match(/www\.openstreetmap\.org.*map=(\d{1,2})\/(-?\d[0-9.]*)\/(-?\d[0-9.]*)/);
      if (match) {
        const [, zoom, lat, lon] = match;
        return [lat, lon, zoom];
      }
    },
  },
  {
    name: "Mapillary",
    category: MAIN_CATEGORY,
    domain: "www.mapillary.com",
	description: "Crowdsourced street-level imagery available as CC BY-SA",
    getUrl(lat, lon, zoom) {
      return 'https://www.mapillary.com/app/?lat=' + lat + '&lng=' + lon + '&z=' + zoom;
    },
    getLatLonZoom(url) {
      const match = url.match(/www\.mapillary\.com.*lat=(-?\d[0-9.]*)&lng=(-?\d[0-9.]*)&z=(\d{1,2})/);
      if (match) {
        const [, lat, lon, zoom] = match;
        return [lat, lon, zoom];
      }
    },
  },
  {
    name: "Âú∞ÁêÜÈô¢Âú∞Âõ≥",
    category: MAIN_CATEGORY,
    domain: "maps.gsi.go.jp",
	description: "Japanese official map",
    getUrl(lat, lon, zoom) {
      return 'https://maps.gsi.go.jp/#' + zoom + '/' + lat + '/' + lon + '/';
    },
    getLatLonZoom(url) {
      const match = url.match(/maps\.gsi\.go\.jp.*#(\d{1,2})\/(-?\d[0-9.]*)\/(-?\d[0-9.]*)/);
      if (match) {
        const [, zoom, lat, lon] = match;
        return [lat, lon, zoom];
      }
    },
  },
  {
    name: "OpenStreetCam",
    category: MAIN_CATEGORY,
    domain: "openstreetcam.org",
	description: "Crowdsourced street-level imagery available as CC BY-SA",
    getUrl(lat, lon, zoom) {
      return 'https://openstreetcam.org/map/@' + lat + ',' + lon + ',' + zoom + 'z';
    },
    getLatLonZoom(url) {
      const match = url.match(/openstreetcam\.org.*@(-?\d[0-9.]*),(-?\d[0-9.]*),(\d{1,2})/);
      if (match) {
        const [, lat, lon, zoom] = match;
        return [lat, lon, zoom];
      }
    },
  },
  {
    name: "F4map",
    category: MAIN_CATEGORY,
    domain: "f4map.com",
	description: "Dynamic 3D map",
    getUrl(lat, lon, zoom) {
      return 'https://demo.f4map.com/#lat=' + lat + '&lon=' + lon + '&zoom=' + zoom;
    },
    getLatLonZoom(url) {
      const match = url.match(/demo\.f4map\.com.*#lat=(-?\d[0-9.]*)&lon=(-?\d[0-9.]*)&zoom=(\d{1,2})/);
      if (match) {
        const [, lat, lon, zoom] = match;
        return [lat, lon, zoom];
      }
    },
  },
  {
    name: "Yandex",
    category: MAIN_CATEGORY,
    domain: "yandex.com",
    getUrl(lat, lon, zoom) {
      return 'https://yandex.com/maps/?ll=' + lon + '%2C' + lat + '&z=' + zoom;
    },
    getLatLonZoom(url) {
      const match = url.match(/yandex.*maps.*ll=(-?\d[0-9.]*)%2C(-?\d[0-9.]*)&z=(\d{1,2})/);
      if (match) {
        const [, lon, lat, zoom] = match;
        return [lat, lon, zoom];
      }
    },
  },
  {
    name: "Qwant Maps",
    category: MAIN_CATEGORY,
    domain: "qwant.com",
	description: "Vector map based on OpenStreetMap data",
    getUrl(lat, lon, zoom) {
      return 'https://www.qwant.com/maps/#map=' + zoom + '/' + lat + '/' + lon;
    },
    getLatLonZoom(url) {
      const match = url.match(/www\.qwant\.com.*#map=(\d{1,2})[0-9.]*\/(-?\d[0-9.]*)\/(-?\d[0-9.]*)/);
      if (match) {
        const [, zoom, lat, lon] = match;
        return [lat, lon, zoom];
      }
    },
  },
  {
    name: "Bing",
    category: MAIN_CATEGORY,
    domain: "www.bing.com",
    getUrl(lat, lon, zoom) {
      return 'https://www.bing.com/maps?cp=' + lat + '~' + lon + '&lvl=' + zoom;
    },
  },
  {
    name: "Overpass-turbo",
    category: UTILITY_CATEGORY,
    domain: "overpass-turbo.eu",
	description: "Power search tool for OpenStreetMap data",
    getUrl(lat, lon, zoom) {
      return 'http://overpass-turbo.eu/?Q=&C=' + lat + ';' + lon + ';' + zoom;
    },
  },
  {
    name: "Osmose",
    category: UTILITY_CATEGORY,
    domain: "osmose.openstreetmap.fr",
	description: "OpenStreetMap QA tool",
    getUrl(lat, lon, zoom) {
      return 'http://osmose.openstreetmap.fr/map/#zoom=' + zoom + '&lat=' + lat + '&lon=' + lon;
    },
    getLatLonZoom(url) {
      const match = url.match(/osmose\.openstreetmap\.fr.*#zoom=(\d{1,2})&lat=(-?\d[0-9.]*)&lon=(-?\d[0-9.]*)/);
      if (match) {
        const [, zoom, lat, lon] = match;
        return [lat, lon, zoom];
      }
    },
  },
  {
    name: "KeepRight",
    category: UTILITY_CATEGORY,
    domain: "www.keepright.at",
	description: "OpenStreetMap QA tool",
    getUrl(lat, lon, zoom) {
      if (Number(zoom) > 18) zoom = 18;
      return 'https://www.keepright.at/report_map.php?zoom=' + zoom + '&lat=' + lat + '&lon=' + lon;
    },
  },
  {
    name: "OSM Inspector",
    category: UTILITY_CATEGORY,
    domain: "tools.geofabrik.de",
	description: "OpenStreetMap QA tool",
    getUrl(lat, lon, zoom) {
      if (Number(zoom) > 18) zoom = 18;
      return 'http://tools.geofabrik.de/osmi/?view=geometry&lon=' + lon + '&lat=' + lat + '&zoom=' + zoom;
    },
  },
  {
    name: "Who did it?",
    category: UTILITY_CATEGORY,
    domain: "simon04.dev.openstreetmap.org",
	description: "OpenStreetMap QA tool",
    getUrl(lat, lon, zoom) {
      if (Number(zoom) > 18) zoom = 18;
      if (Number(zoom) < 12) zoom = 12;
      return 'http://simon04.dev.openstreetmap.org/whodidit/?zoom=' + zoom + '&lat=' + lat + '&lon=' + lon;
    },
  },
  {
    name: "Map compare",
    category: UTILITY_CATEGORY,
    domain: "tools.geofabrik.de",
	description: "Compare maps side-by-side",
    getUrl(lat, lon, zoom) {
      return 'http://tools.geofabrik.de/mc/#' + zoom + '/' + lat + '/' + lon;
    },
    getLatLonZoom(url) {
      const match = url.match(/tools\.geofabrik\.de\/mc\/#(\d{1,2})\/(-?\d[0-9.]*)\/(-?\d[0-9.]*)/);
      if (match) {
        const [, zoom, lat, lon] = match;
        return [lat, lon, zoom];
      }
    },
  },
  {
    name: "Multimapas",
    category: UTILITY_CATEGORY,
    domain: "javier.jimenezshaw.com",
	description: "Compare maps by overlay",
    getUrl(lat, lon, zoom) {
      return 'http://javier.jimenezshaw.com/mapas/mapas.html?z=' + zoom + '&c=' + lat + ',' + lon;
    },
  },
  {
    name: "Ingress Intel map",
    category: SPECIAL_CATEGORY,
    domain: "intel.ingress.com",
    getUrl(lat, lon, zoom) {
      return 'https://intel.ingress.com/intel?ll=' + lat + ',' + lon + '&z=' + zoom;
    },
  },
  {
    name: "Waymarked Trails",
    category: OTHER_CATEGORY,
    domain: "hiking.waymarkedtrails.org",
	description: "Show hiking, cycling, ski routes",
    getUrl(lat, lon, zoom) {
      return 'https://hiking.waymarkedtrails.org/#?map=' + zoom + '!' + lat + '!' + lon;
    },
    getLatLonZoom(url) {
      const match = url.match(/waymarkedtrails\.org.*#\?map=(\d{1,2})!(-?\d[0-9.]*)!(-?\d[0-9.]*)/);
      if (match) {
        const [, zoom, lat, lon] = match;
        return [lat, lon, zoom];
      }
    },
  },
  {
    name: "BigMap 2",
    category: UTILITY_CATEGORY,
    domain: "osmz.ru",
	description: "Obtain a composed big map image",
    getUrl(lat, lon, zoom) {
      return 'http://bigmap.osmz.ru/index.html#map=' + zoom + '/' + lat + '/' + lon;
    },
  },
  {
    name: "Pic4Carto",
    category: UTILITY_CATEGORY,
    domain: "pavie.info",
	description: "OpenStreetMap editor using open street level photos",
    getUrl(lat, lon, zoom) {
      return 'http://projets.pavie.info/pic4carto/index.html?#' + zoom + '/' + lat + '/' + lon;
    },
    getLatLonZoom(url) {
      const match = url.match(/projets\.pavie\.info\/pic4carto\/index\.html.*#(\d{1,2})\/(-?\d[0-9.]*)\/(-?\d[0-9.]*)/);
      if (match) {
        const [, zoom, lat, lon] = match;
        return [lat, lon, zoom];
      }
    },
  },


  {
    name: "JapanMapCompare",
    category: UTILITY_CATEGORY,
    domain: "mapcompare.jp",
	description: "Compare maps side-by-side",
    getUrl(lat, lon, zoom) {
      return 'https://mapcompare.jp/3/' + zoom + '/' + lat + '/' + lon + '/osm/gRoad/mapSatellite';
    },
    getLatLonZoom(url) {
      const match = url.match(/mapcompare\.jp\/\d+\/(\d{1,2})\/(-?\d[0-9.]*)\/(-?\d[0-9.]*)/);
      if (match) {
        const [, zoom, lat, lon] = match;
        return [lat, lon, zoom];
      }
    },
  },

  {
    name: "Yahoo Map (JP)",
    category: LOCAL_CATEGORY,
    domain: "map.yahoo.co.jp",
    getUrl(lat, lon, zoom) {
      return 'https://map.yahoo.co.jp/maps?lat=' + lat + '&lon=' + lon + '&z=' + zoom;
    },
  },
  {
    name: "MapFan (JP)",
    category: LOCAL_CATEGORY,
    domain: "mapfan.com",
    getUrl(lat, lon, zoom) {
      return 'https://mapfan.com/map/spots/search?c=' + lat + ',' + lon + ',' + zoom;
    },
    getLatLonZoom(url) {
      const match = url.match(/mapfan\.com\/map\/spots\/search\?c=(-?\d[0-9.]*),(-?\d[0-9.]*),(\d{1,2})/);
      if (match) {
        const [, lat, lon, zoom] = match;
        return [lat, lon, zoom];
      }
    },
  },
  {
    name: "Mapion (JP)",
    category: LOCAL_CATEGORY,
    domain: "www.mapion.co.jp",
    getUrl(lat, lon, zoom) {
      return 'https://www.mapion.co.jp/m2/' + lat + ',' + lon + ',' + zoom;
    },
  },
  {
    name: "OSM.de",
    category: OSM_LOCAL_CATEGORY,
    domain: "www.openstreetmap.de",
	description: "OpenStreetMap German local chapter",
    getUrl(lat, lon, zoom) {
      return 'https://www.openstreetmap.de/karte.html?zoom=' + zoom + '&lat=' + lat + '&lon=' + lon;
    },
  },
  {
    name: "OSM.ru",
    category: OSM_LOCAL_CATEGORY,
    domain: "openstreetmap.ru",
	description: "OpenStreetMap Russia local chapter",
    getUrl(lat, lon, zoom) {
      return 'https://openstreetmap.ru/#map=' + zoom + '/' + lat + '/' + lon;
    },
    getLatLonZoom(url) {
      const match = url.match(/openstreetmap\.ru\/#map=(\d{1,2})\/(-?\d[0-9.]*)\/(-?\d[0-9.]*)/);
      if (match) {
        const [, zoom, lat, lon] = match;
        return [lat, lon, zoom];
      }
    },
  },
  {
    name: "OSM.jp",
    category: OSM_LOCAL_CATEGORY,
    domain: "openstreetmap.jp",
	description: "OpenStreetMap Japan local chapter",
    getUrl(lat, lon, zoom) {
      return 'https://openstreetmap.jp/map#zoom=' + zoom + '&lat=' + lat + '&lon=' + lon;
    },
    getLatLonZoom(url) {
      const match = url.match(/openstreetmap\.jp\/map#zoom=(\d{1,2})&lat=(-?\d[0-9.]*)&lon=(-?\d[0-9.]*)/);
      if (match) {
        const [, zoom, lat, lon] = match;
        return [lat, lon, zoom];
      }
    },
  },
  {
    name: "OSM.ch",
    category: OSM_LOCAL_CATEGORY,
    domain: "openstreetmap.ch",
	description: "OpenStreetMap Switzerland local chapter",
    getUrl(lat, lon, zoom) {
      return 'https://www.openstreetmap.ch/?zoom=' + zoom + '&lat=' + lat + '&lon=' + lon;
    },

  },

  {
    name: "OSM.in",
    category: OSM_LOCAL_CATEGORY,
    domain: "openstreetmap.in",
	description: "OpenStreetMap India local chapter",
    getUrl(lat, lon, zoom) {
      return 'https://openstreetmap.in/demo/#' + zoom + '/' + lat + '/' + lon ;
    },
    getLatLonZoom(url) {
      const match = url.match(/openstreetmap\.in\/demo\/#(\d[0-9.]*)\/(-?\d[0-9.]*)\/(-?\d[0-9.]*)/);
      if (match) {
        const [, zoom, lat, lon] = match;
        return [lat, normalizeLon(lon), Math.round(Number(zoom))];
      }
    },
  },

  {
    name: "OSM.cl",
    category: OSM_LOCAL_CATEGORY,
    domain: "openstreetmap.cl",
	description: "OpenStreetMap Chile local chapter",
    getUrl(lat, lon, zoom) {
      return 'https://www.openstreetmap.cl/#' + zoom + '/' + lat + '/' + lon;
    },
    getLatLonZoom(url) {
      const match = url.match(/openstreetmap\.cl\/#(\d{1,2})\/(-?\d[0-9.]*)\/(-?\d[0-9.]*)/);
      if (match) {
        let [, zoom, lat, lon] = match;
        return [lat, normalizeLon(lon), zoom];
      }
    },
  },
  
  {
    name: "IGN G√©oportail (FR)",
    category: LOCAL_CATEGORY,
    domain: "geoportail.gouv.fr",
    getUrl(lat, lon, zoom) {
      return 'https://www.geoportail.gouv.fr/carte?c=' + lon + ',' + lat + '&z=' + zoom + '&l0=GEOGRAPHICALGRIDSYSTEMS.MAPS.SCAN25TOUR.CV::GEOPORTAIL:OGC:WMTS(1)&permalink=yes';
    },
  },
  {
    name: "Satellite Tracker 3D",
    category: SPECIAL_CATEGORY,
    domain: "stdkmd.net",
	description: "Satellite tracker",
    getUrl(lat, lon, zoom) {
		const d = Math.round(Math.exp((Number(zoom) - 17.7)/(-1.4)));
      return 'https://stdkmd.net/sat/?cr=' + d + '&lang=en&ll=' + lat + '%2C' + lon ;
    },

  },  
  {
    name: "earth",
    category: SPECIAL_CATEGORY,
    domain: "earth.nullschool.net",
    getUrl(lat, lon, zoom) {
      return 'https://earth.nullschool.net/#current/wind/surface/level/orthographic=' + lon + ',' + lat + ',' + 11.1 * zoom ** 3.12;
    },
    getLatLonZoom(url) {
      const match = url.match(/earth\.nullschool\.net.*orthographic=(-?\d[0-9.]*),(-?\d[0-9.]*),(\d[0-9]*)/);
      if (match) {
        let [, lon, lat, zoom] = match;
        zoom = Math.round((zoom / 11.1) ** (1 / 3.12));
        return [lat, lon, zoom];
      }
    },
  },
  {
    name: "Windy.com",
    category: SPECIAL_CATEGORY,
    domain: "windy.com",
    getUrl(lat, lon, zoom) {
      return 'https://www.windy.com/?' + lat + ',' + lon + ',' + Math.round(zoom) + ',i:pressure';
    },
    getLatLonZoom(url) {
      const match = url.match(/www\.windy\.com.*[,\?](-?\d[0-9.]+),(-?\d[0-9.]+),(\d{1,2})/);
      if (match) {
        const [, lat, lon, zoom] = match;
        return [lat, lon, zoom];
      }
    },
  },
  {
    name: "flightradar24",
    category: SPECIAL_CATEGORY,
    domain: "flightradar24.com",
	description: "Airplane tracker",
    getUrl(lat, lon, zoom) {
      return 'https://www.flightradar24.com/' + Math.round(lat * 100) / 100 + ',' + Math.round(lon * 100) / 100 + '/' + Math.round(zoom);
    },
    getLatLonZoom(url) {
      const match = url.match(/flightradar24\.com.*\/(-?\d[0-9.]*),(-?\d[0-9.]*)\/(\d{1,2})/);
      if (match) {
        const [, lat, lon, zoom] = match;
        return [lat, lon, zoom];
      }
    },
  },
  {
    name: "Traze",
    category: SPECIAL_CATEGORY,
    domain: "traze.app",
	description: "Train tracker",
    getUrl(lat, lon, zoom) {
      return 'https://traze.app/#/@' + lat + ',' + lon + ',' + zoom ;
    },
    getLatLonZoom(url) {
      const match = url.match(/traze\.app\/#\/@(-?\d[0-9.]*),(-?\d[0-9.]*),(\d{1,2})/);
      if (match) {
        let [, lat, lon, zoom] = match;
        return [lat, lon, Math.round(zoom)];
      }
    },

  },  

  {
    name: "MarineTraffic",
    category: SPECIAL_CATEGORY,
    domain: "marinetraffic.com",
	description: "Ship tracker",
    getUrl(lat, lon, zoom) {
      return 'https://www.marinetraffic.com/en/ais/home/centerx:' + lon + '/centery:' + lat + '/zoom:' + zoom;
    },
    getLatLonZoom(url) {
      const match = url.match(/www\.marinetraffic\.com.*centerx:(-?\d[0-9.]*)\/centery:(-?\d[0-9.]*)\/zoom:(\d{1,2})/);
      if (match) {
        const [, lon, lat, zoom] = match;
        return [lat, lon, zoom];
      }
    },
  },


  {
    name: "CyclOSM",
    category: OTHER_CATEGORY,
    domain: "cyclosm.org",
    getUrl(lat, lon, zoom) {
      return 'https://www.cyclosm.org/#map=' + zoom + '/' + lat + '/' + lon + '/cyclosm';
    },
    getLatLonZoom(url) {
      const match = url.match(/www\.cyclosm\.org\/#map=(\d{1,2})\/(-?\d[0-9.]*)\/(-?\d[0-9.]*)\/cyclosm/);
      if (match) {
        let [, zoom, lat, lon] = match;
        return [lat, lon, zoom];
      }
    },
  },

  {
    name: "OpenTopoMap",
    category: OTHER_CATEGORY,
    domain: "opentopomap.org",
    getUrl(lat, lon, zoom) {
      return 'https://opentopomap.org/#map=' + zoom + '/' + lat + '/' + lon;
    },
    getLatLonZoom(url) {
      const match = url.match(/opentopomap\.org\/#map=(\d{1,2})\/(-?\d[0-9.]*)\/(-?\d[0-9.]*)/);
      if (match) {
        let [, zoom, lat, lon] = match;
        return [lat, lon, zoom];
      }
    },
  },

  {
    name: "EO Browser",
    category: SPECIAL_CATEGORY,
    domain: "sentinel-hub.com",
	description: "Satellite sensing image viewer",
    getUrl(lat, lon, zoom) {
      return 'https://apps.sentinel-hub.com/eo-browser/?lat=' + lat + '&lng=' + lon + '&zoom=' + zoom;
    },
    getLatLonZoom(url) {
      const match = url.match(/apps\.sentinel-hub\.com\/eo-browser\/\?lat=(-?\d[0-9.]*)&lng=(-?\d[0-9.]*)&zoom=(\d{1,2})/);
      if (match) {
        let [, lat, lon, zoom] = match;
        return [lat, lon, zoom];
      }
    },
  },  
  
  {
    name: "Macrostrat",
    category: SPECIAL_CATEGORY,
    domain: "macrostrat.org",
	description: "Geological map",
    getUrl(lat, lon, zoom) {
      return 'https://macrostrat.org/map/#/z=' + zoom + '/x=' + lon + '/y=' + lat + '/bedrock/lines/';
    },
    getLatLonZoom(url) {
      const match = url.match(/macrostrat\.org\/map\/#\/z=([0-9.]+)\/x=(-?\d[0-9.]+)\/y=(-?\d[0-9.]+)/);
      if (match) {
        let [, zoom, lon, lat] = match;
        return [lat, lon, zoom];
      }
    },
  },  
 
  {
    name: "Old maps online",
    category: SPECIAL_CATEGORY,
    domain: "oldmapsonline.org",
    getUrl(lat, lon, zoom) {
		const [minlon, minlat, maxlon, maxlat] = latLonZoomToBbox(lat, lon, zoom);
      return 'https://www.oldmapsonline.org/#bbox=' + minlon + ',' + minlat + ',' + maxlon + ',' + maxlat + '&q=&date_from=0&date_to=9999&scale_from=&scale_to=';
    },
    getLatLonZoom(url) {
      const match = url.match(/www\.oldmapsonline\.org\/.*#bbox=(-?\d[0-9.]+),(-?\d[0-9.]+),(-?\d[0-9.]+),(-?\d[0-9.]+)/);
      if (match) {
        let [, minlon, minlat, maxlon, maxlat] = match;
		let [lat, lon, zoom] = bboxToLatLonZoom(minlon, minlat, maxlon, maxlat);
        return [lat, lon, zoom];
      }
    },
  },  


  {
    name: "uMap",
    category: OTHER_CATEGORY,
    domain: "umap.openstreetmap.fr",

    getLatLonZoom(url) {
      const match = url.match(/umap\.openstreetmap\.fr.*#(\d[0-9]*)\/(-?\d[0-9.]*)\/(-?\d[0-9.]*)/);
      if (match) {
        const [, zoom, lat, lon] = match;
        return [lat, lon, zoom];
      }
    },
  },
  {
    name: "Wikimedia maps",
    category: OTHER_CATEGORY,
    domain: "wikimedia.org",
    getUrl(lat, lon, zoom) {
      return 'https://maps.wikimedia.org/#' + zoom + '/' + lat + '/' + lon;
    },
    getLatLonZoom(url) {
      const match = url.match(/maps\.wikimedia\.org\/#(\d[0-9]*)\/(-?\d[0-9.]*)\/(-?\d[0-9.]*)/);
      if (match) {
        let [, zoom, lat, lon] = match;
		let lonnumber = Number(lon);
		if (lonnumber < -180) lonnumber += 360;
        return [lat, lonnumber, zoom];
      }
    },
  },
  {
    name: "OpenTripMap",
    category: OTHER_CATEGORY,
    domain: "opentripmap.com",
    getUrl(lat, lon, zoom) {
      return 'https://opentripmap.com/en/#' + zoom + '/' + lat + '/' + lon;
    },
    getLatLonZoom(url) {
      const match = url.match(/opentripmap\.com\/(.*)\/#(\d[0-9.]*)\/(-?\d[0-9.]*)\/(-?\d[0-9.]*)/);
      if (match) {
        let [, lang, zoom, lat, lon] = match;
		zoom = Math.round(Number(zoom));
        return [lat, lon, zoom];
      }
    },
  },

  {
    name: "Open Infrastructure Map",
    category: OTHER_CATEGORY,
    domain: "openinframap.org",
    getUrl(lat, lon, zoom) {
      return 'https://openinframap.org/#' + zoom + '/' + lat + '/' + lon;
    },
    getLatLonZoom(url) {
      const match = url.match(/openinframap\.org\/#(\d[0-9.]*)\/(-?\d[0-9.]*)\/(-?\d[0-9.]*)/);
      if (match) {
        let [, zoom, lat, lon] = match;
		zoom = Math.round(Number(zoom));
        return [lat, lon, zoom];
      }
    },
  },

  {
    name: "OSM Buildings",
    category: OTHER_CATEGORY,
    domain: "osmbuildings.org",
    getUrl(lat, lon, zoom) {
      return 'https://osmbuildings.org/?lat=' + lat + '&lon=' + lon + '&zoom=' + zoom + '&tilt=30';
    },
    getLatLonZoom(url) {
      const match = url.match(/osmbuildings\.org\/\?lat=(-?\d[0-9.]*)&lon=(-?\d[0-9.]*)&zoom=(\d[0-9.]*)/);
      if (match) {
        let [, zoom, lat, lon] = match;
		zoom = Math.round(Number(zoom));
        return [lat, lon, zoom];
      }
    },
  },

  {
    name: "openrouteservice",
    category: OTHER_CATEGORY,
    domain: "openrouteservice.org",
    getUrl(lat, lon, zoom) {
      return 'https://maps.openrouteservice.org/directions?n1=' + lat + '&n2=' + lon + '&n3=' + zoom;
    },
    getLatLonZoom(url) {
      const match = url.match(/maps\.openrouteservice\.org\/directions\?n1=(-?\d[0-9.]*)&n2=(-?\d[0-9.]*)&n3=(\d{1,2})/);
      if (match) {
        let [, lat, lon, zoom] = match;
        return [lat, lon, zoom];
      }
    },
  },

  {
    name: "OpenRailwayMap",
    category: OTHER_CATEGORY,
    domain: "openrailwaymap.org",
    getUrl(lat, lon, zoom) {
      return 'https://www.openrailwaymap.org/?lat=' + lat + '&lon=' + lon + '&zoom=' + zoom;
    },

  },
  
  {
    name: "ËÅñÂú∞Â∑°Á§º„Éû„ÉÉ„Éó",
    category: SPECIAL_CATEGORY,
    domain: "seichimap.jp",
	description: "Anime location search",
    getUrl(lat, lon, zoom) {
      return 'https://seichimap.jp/spots?order=nearer&lat=' + lat + '&lng=' + lon ;
    },

  },

  {
    name: "OpenAerialMap",
    category: SPECIAL_CATEGORY,
    domain: "openaerialmap.org",
    getUrl(lat, lon, zoom) {
      return 'https://map.openaerialmap.org/#/' + lon + ',' + lat + ',' + zoom;
    },

  },
  
  {
    name: "Âú∞Ë≥™Âõ≥Navi (JP)",
    category: SPECIAL_CATEGORY,
    domain: "gbank.gsj.jp",
	description: "Geological map in Japan",
    getUrl(lat, lon, zoom) {
      return 'https://gbank.gsj.jp/geonavi/geonavi.php#' + zoom + ',' + lat + ',' + lon;
    },

  },
  
  {
    name: "Localwiki",
    category: SPECIAL_CATEGORY,
    domain: "localwiki.org",
    getUrl(lat, lon, zoom) {
		setLocalwikiAddress(lat, lon);
      return 'https://localwiki.org/';
    },

  },
  
  {
    name: "Open JOSM",
    category: APP_CATEGORY,
    domain: "josm.openstreetmap.de",
	description: "OpenStreetMap desktop editor",
    getUrl(lat, lon, zoom) {
		let z = Number(zoom);
		if ( z < 18 ) z = 18;
      return 'https://www.openstreetmap.org/edit?editor=remote#map=' + z + '/' + lat + '/' + lon;
    },

  },
  
  {
    name: "Open iD editor",
    category: APP_CATEGORY,
    domain: "ideditor.com/",
	description: "OpenStreetMap online editor",
    getUrl(lat, lon, zoom) {
		let z = Number(zoom);
		if ( z < 18 ) z = 18;
      return 'https://www.openstreetmap.org/edit?editor=id#map=' + z + '/' + lat + '/' + lon;
    },

  },  

  {
    name: "Apple maps (for Apple device)",
    category: APP_CATEGORY,
    domain: "apple.com/",
    getUrl(lat, lon, zoom) {
      return 'http://maps.apple.com/?ll=' + lat + ',' + lon + '&z=' + zoom;
    },

  },  

  
  {
    name: "mapbox Cartogram",
    category: SPECIAL_CATEGORY,
    domain: "mapbox.com",
	description: "Create colorful map from your photo",
    getUrl(lat, lon, zoom) {
      return 'https://apps.mapbox.com/cartogram/#' + zoom + '/' + lat + '/' + lon;
    },
    getLatLonZoom(url) {
      const match = url.match(/apps\.mapbox\.com\/cartogram\/#(\d[0-9.]*)\/(-?\d[0-9.]*)\/(-?\d[0-9.]*)/);
      if (match) {
        let [, zoom, lat, lon] = match;
        return [lat, lon, Math.round(Number(zoom))];
      }
    },
  },

  {
    name: "waze",
    category: OTHER_CATEGORY,
    domain: "waze.com",
	description: "Crowdsourced route navigation map",
    getUrl(lat, lon, zoom) {
      return 'https://www.waze.com/ul?ll=' + lat + '%2C' + lon + '&navigate=yes&zoom=' + zoom;
    },

  },  
  {
    name: "Open waze map editor",
    category: APP_CATEGORY,
    domain: "waze.com",
    getUrl(lat, lon, zoom) {
      return 'https://www.waze.com/ja/editor?lon=' + lon + '&lat=' + lat + '&zoom=5';
    },

  },
  {
    name: "map.orhyginal",
    category: PORTAL_CATEGORY,
    domain: "orhyginal.fr",
	description: "Portal of many map services",
    getUrl(lat, lon, zoom) {
      return 'http://map.orhyginal.fr/#' + zoom + '/' + lat + '/' + lon;
    },
    getLatLonZoom(url) {
      const match = url.match(/map\.orhyginal\.fr.*#(\d[0-9]*)\/(-?\d[0-9.]*)\/(-?\d[0-9.]*)/);
      if (match) {
        const [, zoom, lat, lon] = match;
        return [lat, lon, zoom];
      }
    },
  },
  {
    name: "here maps",
    category: OTHER_CATEGORY,
    domain: "here.com",
    getUrl(lat, lon, zoom) {
      return 'https://wego.here.com/?map=' + lat + ',' + lon + ',' + zoom + ',normal';
    },
    getLatLonZoom(url) {
      const match = url.match(/wego\.here\.com\/\?map=(-?\d[0-9.]*),(-?\d[0-9.]*),(\d{1,2})/);
      if (match) {
        const [, lat, lon, zoom] = match;
        return [lat, lon, zoom];
      }
    },
  },
  {
    name: "wikimapia",
    category: OTHER_CATEGORY,
    domain: "wikimapia.org",
    getUrl(lat, lon, zoom) {
      return 'https://wikimapia.org/#lat=' + lat + '&lon=' + lon + '&z=' + zoom;
    },
    getLatLonZoom(url) {
      const match = url.match(/wikimapia\.org\/#.*&lat=(-?\d[0-9.]*)&lon=(-?\d[0-9.]*)&z=(\d{1,2})/);
      if (match) {
        const [, lat, lon, zoom] = match;
        return [lat, lon, zoom];
      }
    },
  },

    {
    name: "Copernix",
    category: OTHER_CATEGORY,
    domain: "copernix.io",
	description: "Show POIs from Wikipedia",
    getUrl(lat, lon, zoom) {
      return 'https://copernix.io/#?where=' + lon + ',' + lat + ',' + zoom + '&?query=&?map_type=roadmap';
    },
    getLatLonZoom(url) {
      const match = url.match(/copernix\.io\/#\?where=(-?\d[0-9.]*),(-?\d[0-9.]*),(\d{1,2})/);
      if (match) {
        const [, lon, lat, zoom] = match;
        return [lat, lon, zoom];
      }
    },
  },

    {
    name: "Zoom Earth",
    category: OTHER_CATEGORY,
    domain: "zoom.earth",
	description: "Historic and live satellite images",
    getUrl(lat, lon, zoom) {
      return 'https://zoom.earth/#view=' + lat + ',' + lon + ',' + zoom + 'z';
    },
    getLatLonZoom(url) {
      const match = url.match(/zoom\.earth\/#view=(-?\d[0-9.]*),(-?\d[0-9.]*),(\d{1,2})z/);
      if (match) {
        const [, lat, lon, zoom] = match;
        return [lat, lon, zoom];
      }
    },
  },
  {
    name: "GeoHack",
    category: PORTAL_CATEGORY,
    domain: "wmflabs.org",
	description: "Map links for Wikipedia articles",
    getUrl(lat, lon, zoom) {
		//https://www.mediawiki.org/wiki/GeoHack
      return 'https://tools.wmflabs.org/geohack/geohack.php?params=' + lat + '_N_' + lon + '_E_scale:' + Math.round(100000 * Math.pow(2, 12 - Number(zoom)));
    },

  },

  {
    name: "Google Earth",
    category: OTHER_CATEGORY,
    domain: "earth.google.com",
    getUrl(lat, lon, zoom) {
	  let d = Math.exp((zoom - 27)/(-1.44))
      return 'https://earth.google.com/web/@' + lat + ',' + lon + ',' + d + 'd';
    },
    getLatLonZoom(url) {
      let match;
      match = url.match(/earth\.google\.com\/web\/@(-?\d[0-9.]*),(-?\d[0-9.]*),(-?\d[0-9.]*)a,(-?\d[0-9.]*)d/);
	  if (match) {
        let [, lat, lon, , zoom] = match;
        zoom = Math.round(-1.44 * Math.log(zoom) + 27);
        return [lat, lon, zoom];
	  }

    },
  },

  {
    name: "World Imagery Wayback",
    category: OTHER_CATEGORY,
    domain: "arcgis.com",
	description: "Historic satellite images since 2014",
    getUrl(lat, lon, zoom) {
		const [minlon, minlat, maxlon, maxlat] = latLonZoomToBbox(lat, lon, zoom);
		return 'http://livingatlas.arcgis.com/wayback/?ext=' + minlon + ',' + minlat + ',' + maxlon + ',' + maxlat;
    },
    getLatLonZoom(url) {
      let match;
      if (match = url.match(/livingatlas\.arcgis\.com\/wayback\/\?ext=(-?\d[0-9.]*),(-?\d[0-9.]*),(-?\d[0-9.]*),(-?\d[0-9.]*)/)) {
        const [, minlon, minlat, maxlon, maxlat] = match;
        const [lat, lon, zoom] = bboxToLatLonZoom(minlon, minlat, maxlon, maxlat);
        return [lat, lon, zoom];
	  }

    },
  },

  {
    name: "OpenGeofiction",
    category: SPECIAL_CATEGORY,
    domain: "opengeofiction.net",
    getUrl(lat, lon, zoom) {
      return 'https://opengeofiction.net/#map=' + zoom + '/' + lat + '/' + lon;
    },
    getLatLonZoom(url) {
      const match = url.match(/opengeofiction\.net.*map=(\d{1,2})\/(-?\d[0-9.]*)\/(-?\d[0-9.]*)/);
      if (match) {
        const [, zoom, lat, lon] = match;
        return [lat, lon, zoom];
      }
    },
  },
  
];

//https://stackoverflow.com/questions/14446511/most-efficient-method-to-groupby-on-an-array-of-objects
function groupBy(xs, key) {
  return xs.reduce(function(rv, x) {
    (rv[x[key]] = rv[x[key]] || []).push(x);
    return rv;
  }, {});
};
    function setAddress(lat, lon){
			var request = new XMLHttpRequest();
			request.open('GET', 'https://nominatim.openstreetmap.org/reverse?format=json&lat=' + lat + '&lon=' + lon + '&zoom=10&addressdetails=1', true);
			request.responseType = 'json';
			request.onload = function () {
				var data = this.response;
				document.getElementById("address").innerHTML = data.display_name;
			};
			request.send();
		}

function normalizeLon(lon){
	lon = Number(lon);
	lon = lon % 360;
	lon += 360;
	lon = lon % 360;
	if(lon > 180) lon -= 360;
	return lon;
}

		
function getLatLonZoom(url, maps) {
	for (let map of maps){
		if (map.hasOwnProperty('getLatLonZoom')){
			let latlonzoom = map.getLatLonZoom(url);
			if (latlonzoom) return latlonzoom;
		}
	}
	return ;
}

let lat, lon, zoom;

/* 
const testurl = "https://www.openstreetmap.org/#map=13/33.0354/129.7383&layers=N";
let latlonzoom = getLatLonZoom(testurl, maps);
*/

  let elementUrl = document.getElementById("showurl");
  let prevUrls = location.href.match(/#(.*)$/);

  if (prevUrls) {
    let prevUrl = prevUrls[1];
    document.getElementById("description").style.display = "none";
    elementUrl.innerHTML = prevUrl;
    let latlonzoom;
    latlonzoom = getLatLonZoom(prevUrl, maps);
	if (latlonzoom){
	  [lat, lon, zoom] = latlonzoom;
	}
	else {
		[lat, lon, zoom] = [0, 0, 4];
	document.getElementById("sorry").innerHTML = "<strong>Sorry, this URL is not supported. Sample links are shown here.</strong>";
	}
  }
  else {
	[lat, lon, zoom] = [0, 0, 4];
	document.getElementById("sorry").innerHTML = "<strong>Install above bookmarklet first.</strong> Sample links are shown here.";
  }
  




  setAddress(lat,lon);	
  document.getElementById("lat").innerHTML = lat;
  document.getElementById("lon").innerHTML = lon;
  document.getElementById("zoom").innerHTML = zoom;

  let columns = groupBy(maps, 'category');
 
  let maplist = "";
  
  let categories = Object.keys(columns);

  for (let category of categories){
	  maplist += '<ul class="submaps" id="' + category + '"><li class="title">' + category + '</li>';
	  let mapsublist = columns[category];
  //alert(category);	  
	    for (let map of mapsublist){
			if (map.hasOwnProperty('getUrl')) {
				let tooltip = "";
				if (map.hasOwnProperty('description')) tooltip = ' title="' + map.description + '" ';
				maplist += '<li>' + '<img src="http://www.google.com/s2/favicons?domain=' + map.domain + '">' + '<a href="' + map.getUrl(lat,lon,zoom) + '" id="' + map.name + '"'+ tooltip + '>' + map.name + '</a></li>';
			}
		}
		maplist += '</ul>';
  }
  

  /*
  for (let column of columns)
  
  let maplist = "";
  for (let map of maps){
	maplist = maplist + '<li>' + '<img src="http://www.google.com/s2/favicons?domain=' + map.domain + '">' + '<a href="' + map.getUrl(lat,lon,zoom) + '">' + map.name + '</li>';
  };
  */
  document.getElementById("maps").innerHTML =  maplist;

  
  
</script>

      
</body>
</html>
